<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Projects â€” ReqAutomation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
  <style>
    /* Additional styles for sidebar layout */
    html,
    body {
      height: 100%;
      margin: 0;
    }

    .sidebar {
      background: linear-gradient(180deg, #2c3e50 0%, #1a2530 100%);
      color: white;
      transition: all 0.3s;
      height: calc(100vh - 56px);
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }

    .sidebar-stats {
      padding: 1rem 1.5rem;
      background: rgba(0, 0, 0, 0.2);
      flex-shrink: 0;
    }

    .sidebar-projects {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }

    .project-item {
      padding: 0.75rem 1.5rem;
      border-left: 4px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .project-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-left-color: #4361ee;
    }

    .project-item.active {
      background: rgba(67, 97, 238, 0.15);
      border-left-color: #4361ee;
    }

    .project-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .project-date {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-left: 0.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .stat-box {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #4cc9f0;
    }

    .stat-label {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .container-fluid.p-0 {
      height: calc(100vh - 56px);
    }

    .row.g-0 {
      height: 100%;
    }

    .col-lg-3,
    .col-lg-9 {
      height: 100%;
    }

    .content-area {
      background: #f8f9fa;
      height: calc(100vh - 56px);
      padding: 2rem;
      overflow-y: auto;
    }

    .workspace-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      height: 100%;
    }

    .requirement-item {
      border-left: 4px solid #e9ecef;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 0 8px 8px 0;
      transition: all 0.2s;
    }

    .requirement-item:hover {
      border-left-color: #4361ee;
      background: #f8f9ff;
    }

    .requirement-item.functional {
      border-left-color: #28a745;
    }

    .requirement-item.non-functional {
      border-left-color: #ffc107;
    }

    .requirement-item.uncertain {
      border-left-color: #6c757d;
    }

    .new-req-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .category-badge-lg {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9em;
    }

    .category-functional-lg {
      background: #d4edda;
      color: #155724;
    }

    .category-non-functional-lg {
      background: #cce7ff;
      color: #004085;
    }

    .category-uncertain-lg {
      background: #fff3cd;
      color: #856404;
    }

    /* Scrollbar styling */
    .sidebar-projects::-webkit-scrollbar {
      width: 5px;
    }

    .sidebar-projects::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
    }

    .sidebar-projects::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }

    .navbar-grid {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      height: 56px;
      padding: 0 1rem;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container navbar-grid">
      <!-- Logo and Brand -->
      <div class="navbar-logo-wrapper">
        <span class="fw-bold" style="color: #0B5ED7;">
          <h2>Clarify</h2>
        </span>
      </div>

      <!-- Empty spacer for middle -->
      <div></div>

      <!-- Logout button -->
      <div>
        <a class="btn btn-sm btn-primary" href="/logout">
          <i class="fas fa-sign-out-alt me-1"></i>Logout
        </a>
      </div>
    </div>
  </nav>

  <div class="container-fluid p-0">
    <div class="row g-0">
      <!-- Sidebar -->
      <div class="col-lg-3">
        <div class="sidebar">
          <div class="sidebar-header">
            <h4 class="mb-3"><i class="fas fa-folder me-2"></i>My Projects</h4>
            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#createProjectModal">
              <i class="fas fa-plus-circle me-2"></i>New Project
            </button>
          </div>

          <div class="sidebar-projects" id="projectsList">
            <!-- Projects will be loaded here -->
            <div class="text-center py-5 text-muted" id="noProjectsMessage">
              <i class="fas fa-folder-open fa-2x mb-3"></i>
              <p>No projects yet.<br>Create your first project!</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="col-lg-9">
        <div class="content-area">
          <!-- Welcome/Select Project State -->
          <div class="text-center py-5" id="welcomeState">
            <i class="fas fa-folder-open fa-4x text-muted mb-4"></i>
            <h2 class="text-muted">Welcome to Projects</h2>
            <p class="lead text-muted mb-4">Select a project from the sidebar or create a new one to get started</p>
            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createProjectModal">
              <i class="fas fa-plus-circle me-2"></i>Create Project
            </button>
          </div>

          <!-- Project Workspace (Hidden by default) -->
          <div id="projectWorkspace" style="display: none;">
            <!-- Project Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
              <div>
                <h2 id="projectTitle" class="mb-1"></h2>
                <p class="text-muted mb-0" id="projectMeta">
                  <i class="fas fa-calendar-alt me-1"></i>Created: <span id="projectCreatedDate"></span>
                </p>
              </div>
              <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="refreshProject()">
                  <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#createProjectModal">
                  <i class="fas fa-plus me-1"></i>New Project
                </button>
              </div>
            </div>

            <!-- New Requirement Card -->
            <div class="new-req-card">
              <h4 class="mb-3"><i class="fas fa-edit me-2"></i>Add New Requirement</h4>
              <div class="mb-3">
                <textarea class="form-control" id="requirementInput" rows="3"
                  placeholder="Enter your requirement here..."></textarea>
              </div>
              <div class="d-flex gap-2">
                <button id="analyzeBtn" class="btn btn-light">
                  <i class="fas fa-search me-2"></i>Save
                </button>
                <button id="clearBtn" class="btn btn-outline-light">
                  <i class="fas fa-times me-2"></i>Clear
                </button>
              </div>

              <!-- Analysis Result -->
              <div id="analysisResult" class="mt-4" style="display:hidden;">
                <div class="alert alert-light" role="alert">
                  <h5 class="alert-heading"><i class="fas fa-chart-bar me-2"></i>Analysis Result</h5>
                  <hr>
                  <p class="mb-1"><strong>Original Requirement:</strong></p>
                  <p id="original" class="mb-3"></p>
                  <div class="d-flex align-items-center">
                    <strong class="me-3">Category:</strong>
                    <span id="categoryBadge" class="category-badge-lg"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Requirements List -->
            <div class="workspace-card p-4">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0"><i class="fas fa-list-check me-2"></i>Project Requirements</h4>
                <span class="badge bg-primary" id="requirementsCount">0 requirements</span>
              </div>

              <div id="requirementsList">
                <!-- Requirements will be loaded here -->
                <div class="text-center py-4 text-muted">
                  <i class="fas fa-inbox fa-2x mb-3"></i>
                  <p>No requirements yet.<br>Add your first requirement above!</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Project Modal -->
  <div class="modal fade" id="createProjectModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <form id="createProjectForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Create New Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Project Name</label>
            <input id="projectNameInput" class="form-control" placeholder="Enter project name" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Description (Optional)</label>
            <textarea id="projectDescInput" class="form-control" rows="2"
              placeholder="Brief description of the project"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Create Project</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let selectedProjectId = null;
    let selectedProjectName = null;
    let selectedProjectCreated = null;

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function () {
      loadProjects();
      setupEventListeners();
    });

    async function loadProjects() {
      try {
        const res = await fetch('/projects');
        if (!res.ok) {
          if (res.status === 401) {
            window.location.href = '/login_page';
            return;
          }
          throw new Error('Failed to load projects');
        }
        const projects = await res.json();
        updateProjectsList(projects);
        updateProjectStats(projects);
      } catch (e) {
        console.error(e);
        showToast('Error loading projects', 'error');
      }
    }

    function updateProjectsList(projects) {
      const projectsList = document.getElementById('projectsList');
      const noProjectsMessage = document.getElementById('noProjectsMessage');

      if (projects.length === 0) {
        noProjectsMessage.style.display = 'block';
        projectsList.innerHTML = '';
      } else {
        noProjectsMessage.style.display = 'none';

        let projectsHTML = '';
        projects.forEach((project, index) => {
          const createdDate = new Date(project.created_at || Date.now()).toLocaleDateString();
          const isActive = selectedProjectId === project.id ? 'active' : '';

          projectsHTML += `
        <div class="project-item ${isActive}" onclick="selectProject(${project.id}, '${project.name}', '${createdDate}')">
          <div class="d-flex align-items-center">
            <i class="fas fa-folder text-warning me-3"></i>
            <div>
              <div class="project-name">${project.name}</div>
            </div>
          </div>
          <div class="project-date">${createdDate}</div>
        </div>
      `;
        });

        projectsList.innerHTML = projectsHTML;
      }
    }

    function updateProjectStats(projects) {
      const statsContainer = document.getElementById('projectStats');
      const totalProjects = projects.length;

      // Count requirements per category (this would need backend data)
      const functionalCount = projects.reduce((sum, p) => sum + (p.functional_count || 0), 0);
      const nonFunctionalCount = projects.reduce((sum, p) => sum + (p.non_functional_count || 0), 0);
      const totalRequirements = functionalCount + nonFunctionalCount + (projects.reduce((sum, p) => sum + (p.uncertain_count || 0), 0));

      statsContainer.innerHTML = `
    <div class="stat-box">
      <div class="stat-value">${totalProjects}</div>
      <div class="stat-label">Projects</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">${totalRequirements}</div>
      <div class="stat-label">Requirements</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">${functionalCount}</div>
      <div class="stat-label">Functional</div>
    </div>
    <div class="stat-box">
      <div class="stat-value">${nonFunctionalCount}</div>
      <div class="stat-label">Non-Functional</div>
    </div>
  `;
    }

    function selectProject(projectId, projectName, createdDate) {
      selectedProjectId = projectId;
      selectedProjectName = projectName;
      selectedProjectCreated = createdDate;

      // Update UI state
      document.getElementById('welcomeState').style.display = 'none';
      document.getElementById('projectWorkspace').style.display = 'block';

      // Update project info
      document.getElementById('projectTitle').textContent = projectName;
      document.getElementById('projectCreatedDate').textContent = createdDate;

      // Update active state in sidebar
      document.querySelectorAll('.project-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelectorAll(`.project-item`).forEach(item => {
        if (item.textContent.includes(projectName)) {
          item.classList.add('active');
        }
      });

      // Load project requirements
      loadProjectRequirements(projectId);
    }

    async function loadProjectRequirements(projectId) {
      try {
        const res = await fetch(`/project/${projectId}/requirements`);
        if (!res.ok) throw new Error('Failed to load requirements');
        const requirements = await res.json();

        updateRequirementsList(requirements);
      } catch (err) {
        console.error(err);
        showToast('Error loading requirements', 'error');
      }
    }

    function updateRequirementsList(requirements) {
      const requirementsList = document.getElementById('requirementsList');
      const requirementsCount = document.getElementById('requirementsCount');

      requirementsCount.textContent = `${requirements.length} requirement${requirements.length !== 1 ? 's' : ''}`;

      if (requirements.length === 0) {
        requirementsList.innerHTML = `
      <div class="text-center py-4 text-muted">
        <i class="fas fa-inbox fa-2x mb-3"></i>
        <p>No requirements yet.<br>Add your first requirement above!</p>
      </div>
    `;
        return;
      }

      let requirementsHTML = '';
      requirements.forEach((req, index) => {
        const createdDate = new Date(req.created_at).toLocaleString();
        const categoryClass = req.category.toLowerCase().replace('-', '');

        requirementsHTML += `
      <div class="requirement-item ${categoryClass}">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <span class="badge bg-light text-dark me-2">#${index + 1}</span>
            <strong>${req.category}</strong>
          </div>
          <small class="text-muted">${createdDate}</small>
        </div>
        <p class="mb-0">${req.text}</p>
        ${req.tokens ? `<small class="text-muted mt-2 d-block">Tokens: ${Array.isArray(req.tokens) ? req.tokens.join(', ') : req.tokens}</small>` : ''}
      </div>
    `;
      });

      requirementsList.innerHTML = requirementsHTML;
    }

    async function createProject(e) {
      e.preventDefault();
      const name = document.getElementById('projectNameInput').value.trim();
      const description = document.getElementById('projectDescInput').value.trim();

      if (!name) {
        showToast('Please enter a project name', 'warning');
        return;
      }

      const res = await fetch('/project/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          project_name: name,
          description: description
        })
      });

      const data = await res.json();
      if (res.ok) {
        showToast('Project created successfully!', 'success');
        document.getElementById('projectNameInput').value = '';
        document.getElementById('projectDescInput').value = '';
        const modal = bootstrap.Modal.getInstance(document.getElementById('createProjectModal'));
        modal.hide();
        loadProjects();
      } else {
        showToast(data.error || 'Could not create project', 'error');
      }
    }

    async function addRequirement() {
      if (!selectedProjectId) {
        showToast('Please select a project first', 'warning');
        return;
      }

      const text = document.getElementById('requirementInput').value.trim();
      if (!text) {
        showToast('Please enter a requirement', 'warning');
        return;
      }

      // Show loading state
      const analyzeBtn = document.getElementById('analyzeBtn');
      const originalBtnText = analyzeBtn.innerHTML;
      analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
      analyzeBtn.disabled = true;

      try {
        const res = await fetch(`/project/${selectedProjectId}/add_requirement`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ requirement: text })
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Error analyzing requirement');
        }

        // Show result
        document.getElementById('original').textContent = data.original;

        const categoryBadge = document.getElementById('categoryBadge');
        categoryBadge.textContent = data.category;
        categoryBadge.className = `category-badge-lg category-${data.category.toLowerCase().replace('-', '-')}`;

        document.getElementById('analysisResult').style.display = 'block';
        document.getElementById('requirementInput').value = '';

        // Refresh requirements list
        loadProjectRequirements(selectedProjectId);

        showToast('Requirement added successfully!', 'success');

      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        // Reset button
        analyzeBtn.innerHTML = originalBtnText;
        analyzeBtn.disabled = false;
      }
    }

    function refreshProject() {
      if (selectedProjectId) {
        loadProjectRequirements(selectedProjectId);
        showToast('Project refreshed', 'info');
      }
    }

    function setupEventListeners() {
      // Create project form
      document.getElementById('createProjectForm').addEventListener('submit', createProject);

      // Analyze button
      document.getElementById('analyzeBtn').addEventListener('click', addRequirement);

      // Clear button
      document.getElementById('clearBtn').addEventListener('click', function () {
        document.getElementById('requirementInput').value = '';
        document.getElementById('analysisResult').style.display = 'none';
      });

      // Enter key in requirement textarea
      document.getElementById('requirementInput').addEventListener('keydown', function (e) {
        if (e.ctrlKey && e.key === 'Enter') {
          e.preventDefault();
          addRequirement();
        }
      });
    }

    function showToast(message, type = 'info') {
      // Create toast element
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'success' ? 'success' : 'primary'} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');

      toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  `;

      // Add to container
      const container = document.getElementById('toastContainer') || (() => {
        const div = document.createElement('div');
        div.id = 'toastContainer';
        div.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(div);
        return div;
      })();

      container.appendChild(toast);

      // Show toast
      const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
      bsToast.show();

      // Remove after hide
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }
  </script>
</body>

</html>